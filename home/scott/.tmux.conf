##### Prefix like GNU Screen
unbind C-b
set -g prefix C-a
bind C-a send-prefix

##### Splits like Screen
bind | split-window -h
bind - split-window -v

##### Windows
bind c new-window
bind n next-window
bind p previous-window
bind k kill-window
bind d detach
bind A command-prompt "rename-window %%"

# Screen-style window list
bind '"' choose-tree -Zw

##### Mouse + copy mode
set -g mouse on
setw -g mode-keys vi

# When ctrl+g is hit, clear the selection but stay in copy mode.
bind -T copy-mode-vi C-g send -X clear-selection
bind -T copy-mode    C-g send -X clear-selection

# Exit copy mode when escape is pressed
# In copy mode, make Escape behave like q: always cancel/exit
unbind Escape
unbind -T copy-mode Escape
unbind -T copy-mode-vi Escape

bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode    Escape send -X cancel

# Native clipboard support if available
set -g set-clipboard on

# Screen-like copy mode: Enter starts or finishes selection, copies via xclip
# Modified: when selection is active/present, Enter copies to clipboard, clears selection,
# but STAYS in copy mode.
bind -T copy-mode-vi Enter if -F '#{||:#{selection_active},#{selection_present}}' \
  'send -X copy-pipe "xclip -in"' \
  'send -X begin-selection'
bind -T copy-mode Enter if -F '#{||:#{selection_active},#{selection_present}}' \
  'send -X copy-pipe "xclip -in"' \
  'send -X begin-selection'

# Explicit yank key
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -in"
bind -T copy-mode y send -X copy-pipe-and-cancel "xclip -in"

##### Emacs-style registers (step 2: registers 1 & 2)
# Copy mode: r s {1,2} -> save selection into named buffers reg-1 / reg-2.
bind -T copy-mode-vi r switch-client -T register-copy \; display-message "register-mode"
bind -T copy-mode    r switch-client -T register-copy \; display-message "register-mode"

bind -T register-copy s switch-client -T register-copy-save \; display-message "register-mode: press register key to copy"
bind -T register-copy Escape switch-client -T copy-mode-vi \; display-message ""
bind -T register-copy q switch-client -T copy-mode-vi \; display-message ""

# Use `pipe` (not `copy-pipe`) so the selection is piped into tmux load-buffer and
# the named buffer is created as reg-1 / reg-2 (and the selection clears).
bind -T register-copy-save 1 send -X pipe "tmux load-buffer -b reg-1 -" \; display-message "saved reg-1" \; switch-client -T copy-mode-vi
bind -T register-copy-save 2 send -X pipe "tmux load-buffer -b reg-2 -" \; display-message "saved reg-2" \; switch-client -T copy-mode-vi
bind -T register-copy-save Escape switch-client -T copy-mode-vi \; display-message ""
bind -T register-copy-save q switch-client -T copy-mode-vi \; display-message ""

# Normal mode: <prefix> r g {1,2} -> paste from reg-1 / reg-2; <prefix> r l -> list buffers.
bind -T prefix r switch-client -T register-prefix \; display-message "register-mode"

bind -T register-prefix g switch-client -T register-prefix-paste \; display-message "register-mode: press register key to paste"
bind -T register-prefix l choose-buffer \; switch-client -T root \; display-message ""
bind -T register-prefix Escape switch-client -T root \; display-message ""
bind -T register-prefix q switch-client -T root \; display-message ""

bind -T register-prefix-paste 1 paste-buffer -b reg-1 \; switch-client -T root \; display-message "pasted reg-1"
bind -T register-prefix-paste 2 paste-buffer -b reg-2 \; switch-client -T root \; display-message "pasted reg-2"
bind -T register-prefix-paste Escape switch-client -T root \; display-message ""
bind -T register-prefix-paste q switch-client -T root \; display-message ""

# Screen-ish entry to copy/scrollback
bind [ copy-mode

##### “Only” current pane like Screen’s prefix q / Q
bind Q kill-pane -a
bind q kill-pane -a

##### Terminal / colors
set -g default-terminal "screen-256color"

# Mouse: don't auto-copy/exit on release; keep highlight and stay in copy-mode
unbind -T copy-mode-vi MouseDragEnd1Pane
unbind -T copy-mode    MouseDragEnd1Pane
bind   -T copy-mode-vi MouseDragEnd1Pane send -X stop-selection
bind   -T copy-mode    MouseDragEnd1Pane send -X stop-selection